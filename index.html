<!DOCTYPE html>
<html lang="ko" data-bs-theme="auto">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0">
  <title>Í∏∞Ïà† ÏΩòÌÖêÏ∏† Î¶¨Ïä§Ìä∏</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/locale/ko.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>


  <div id="app" class="container">
    <div id="content-list" class="list-group">
      <in-dom-link-item v-for="(item, index) in items" :key="index" :link="item.link"
        :title="item.translated_title || item.title" :summary="item.translated_summary || item.summary"
        :media="item.media"
        :media-class="item.mediaClass"
        :created-from-now="item.createdFromNow"
        :id="item.id"
        :opinion="item.opinion"
        :summary-request-api="item.summaryRequestApi"
        :summary-api="item.summaryApi"
        :opinion-api="item.opinionApi"
        :pinned="item.pinned"
        >
      </in-dom-link-item>
    </div>
  </div>

  <script>

    const SUPABASE_URL = 'https://xjrkvaolxrzexiybclbc.supabase.co';
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhqcmt2YW9seHJ6ZXhpeWJjbGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5OTcxNjksImV4cCI6MjA2NTU3MzE2OX0.cl19LcqXWfufKaxnb79q6NGBVLrLdzGk4tXzNeEZ89c';
    const TABLE_NAME = 'articles';

    const params = new URLSearchParams(window.location.search);
    const summaryRequestApi = params.get('summaryRequestApi');
    const summaryApi = params.get('summaryApi');
    const opinionApi = params.get('opinionApi');

    const classes = [
      'text-bg-secondary',
      'text-bg-success',
      'text-bg-danger',
      'text-bg-warning',
      'text-bg-info',
    ];

    function getHashedClass(text) {
      const prefix = text.slice(0, 2);
      let hash = 0;

      // Í∞ÑÎã®Ìïú Î¨∏ÏûêÏó¥ Ìï¥Ïã± (Î¨∏Ïûê ÏΩîÎìú Í∏∞Î∞ò)
      for (let i = 0; i < prefix.length; i++) {
        hash = (hash << 5) - hash + prefix.charCodeAt(i);
        hash |= 0; // 32ÎπÑÌä∏ Ï†ïÏàòÎ°ú Î≥ÄÌôò
      }

      const index = Math.abs(hash) % classes.length;
      return classes[index];
    }

    const { createApp, ref } = Vue

    createApp({
      data() {
        return {
          items: [

          ]
        };
      },
      async mounted() {
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - 10);

        const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?created_at=gte.${threeDaysAgo.toISOString()}&order=created_at.desc`;

        const res = await fetch(url, {
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Accept': 'application/json'
          }
        });

        if (!res.ok) {
          document.getElementById('content-list').textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.';
          return;
        }

        const data = await res.json();
        
        // 48ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïùò ÏΩòÌÖêÏ∏† Ï§ë opinionÏù¥ ÏûàÎäî Ìï≠Î™©ÏùÑ ÏÉÅÎã®ÏúºÎ°ú Ï†ïÎ†¨
        const now = new Date();
        const fortyEightHoursAgo = new Date(now.getTime() - (72 * 60 * 60 * 1000));
        
        data.sort((a, b) => {
          const aCreatedAt = new Date(a.created_at);
          const bCreatedAt = new Date(b.created_at);
          
          // 48ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïùò ÏΩòÌÖêÏ∏†Ïù∏ÏßÄ ÌôïÏù∏
          const aIsRecent = aCreatedAt > fortyEightHoursAgo;
          const bIsRecent = bCreatedAt > fortyEightHoursAgo;
          
          // opinion ÌïÑÎìúÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
          const aHasOpinion = a.opinion && a.opinion.trim() !== '';
          const bHasOpinion = b.opinion && b.opinion.trim() !== '';
          
          // 48ÏãúÍ∞Ñ Ïù¥ÎÇ¥ + opinionÏù¥ ÏûàÎäî Ìï≠Î™©ÏùÑ Ïö∞ÏÑ† Ï†ïÎ†¨
          if (aIsRecent && aHasOpinion && !(bIsRecent && bHasOpinion)) {
            return -1;
          }
          if (bIsRecent && bHasOpinion && !(aIsRecent && aHasOpinion)) {
            return 1;
          }
          
          // Í∑∏ Ïô∏ÏóêÎäî Í∏∞Î≥∏ Ï†ïÎ†¨ (created_at desc)
          return bCreatedAt - aCreatedAt;
        });

        data.forEach(item => {
          item.createdFromNow = moment(item.created_at).fromNow();
          item.mediaClass = getHashedClass(item.media);
          item.summaryRequestApi = summaryRequestApi;
          item.summaryApi = summaryApi;
          item.opinionApi = opinionApi;
          
          // 48ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïùò ÏΩòÌÖêÏ∏†Ïù¥Í≥† opinionÏù¥ ÏûàÏúºÎ©¥ pinned = trueÎ°ú ÏÑ§Ï†ï
          const itemCreatedAt = new Date(item.created_at);
          if (itemCreatedAt > fortyEightHoursAgo && item.opinion && item.opinion.trim() !== '') {
            item.pinned = true;
          }
        });


        


        this.items.push(...data);
      },
      components: {
        InDomLinkItem: {
          props: ["link", "title", "summary", "createdFromNow", "media", "mediaClass", "id", "opinion", "pinned", "summaryRequestApi", "summaryApi", "opinionApi"],
          data() {
            return {
              opinionText: this.opinion || '',
              summaryText: this.summary || ''
            };
          },
          methods: {
            handleSummaryRequestApi() {
              if (!this.summaryRequestApi || !this.id) return;
              const url = `${this.summaryRequestApi}?id=${encodeURIComponent(this.id)}`;
              fetch(url, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                  
                })
                .catch(() => {
                  
                });
            },
            handleOpinionSave() {
              if (!this.opinionApi || !this.id) return;
              const url = `${this.opinionApi}`;
              fetch(url, { 
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: this.id, opinion: this.opinionText })
              })
                .then(res => res.json())
                .then(data => {
                  
                })
                .catch(() => {
                  
                });
            },
            handleSummarySave() {
              if (!this.summaryApi || !this.id) return;
              const url = `${this.summaryApi}`;
              fetch(url, { 
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: this.id, summary: this.summaryText })
              })
                .then(res => res.json())
                .then(data => {
                  
                })
                .catch(() => {
                  
                });
            }
          },
          template: `
            <a class="list-group-item list-group-item-action" :href="link" target="_blank">
              <div class="d-flex w-100 justify-content-between">
                <small class="fw-bold"> {{ pinned ? 'üìå' : '' }} {{ title }}</small>
              </div>
              <small class="mb-1 text-bold">
                <span
                  class="badge rounded-pill me-1"
                  :class="mediaClass"
                >
                  {{ media }}
                </span>
                <span
                  class="badge rounded-pill me-1 text-bg-dark"
                >
                  {{ createdFromNow }}
                </span>
              </small>
              <small class="d-block" v-if="opinion">
                <span
                  class="badge rounded-pill text-danger"
                >Î©îÎ™®</span>{{ opinion }}</small>
              <small class="d-block" v-if="summary">
                <span
                  class="badge rounded-pill text-info"
                >ÏöîÏïΩ</span>
                {{ summary }}</small>
              <div v-if="summaryRequestApi" class="mt-2">
                <button class="btn btn-sm btn-outline-primary" type="button" @click.stop.prevent="handleSummaryRequestApi">
                  ÏöîÏïΩ ÏöîÏ≤≠
                </button>
              </div>
              <div v-if="summaryApi" class="mt-2">
                <div class="input-group input-group-sm">
                  <textarea 
                    rows="3"
                    class="form-control" 
                    placeholder="ÏöîÏïΩÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                    v-model="summaryText"
                    @click.stop.prevent
                  />
                  <button 
                    class="btn btn-outline-info" 
                    type="button" 
                    @click.stop.prevent="handleSummarySave"
                  >
                    ÏöîÏïΩ Ï†ÄÏû•
                  </button>
                </div>
              </div>
              <div v-if="opinionApi" class="mt-2">
                <div class="input-group input-group-sm">
                  <textarea 
                    rows="5"
                    class="form-control" 
                    placeholder="ÏùòÍ≤¨ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                    v-model="opinionText"
                    @click.stop.prevent
                  />
                  <button 
                    class="btn btn-outline-danger" 
                    type="button" 
                    @click.stop.prevent="handleOpinionSave"
                  >
                    Î©îÎ™® Ï†ÄÏû•
                  </button>
                </div>
              </div>
            </a>
          `,
        },
      },
    }).mount("#app");
    moment.locale('ko');
  </script>
</body>

</html>
